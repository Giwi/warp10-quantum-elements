<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../app-pouchdb/app-pouchdb-document.html">
<link rel="import" href="../app-pouchdb/app-pouchdb-query.html">
<link rel="import" href="../app-pouchdb/app-pouchdb-index.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<link rel="import" href="../paper-badge/paper-badge.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">

<link rel="import" href="../moment-js/moment-js.html">


<dom-module id="quantum-local-collection-reader">
  <template>
    <style>
      :host {   
        width: 80vw;
        background: white;
        transition: box-shadow 0.5s cubic-bezier(.25,.8,.25,1);
        box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        overflow : auto;
        border-radius: 2px;
        padding: 15px;
        --app-primary-color: var(--google-blue-500);
        --app-secondary-color: black;
        --app-background-color: white;
        --app-on-background-color: white;
      }
      [hidden] {
        display : none !important;
      }
      #closeReadCollection {
        position: absolute;
        justify-content: flex-end;
        right: 16px;
        top: 16px;
        margin: 0;
        transition: color 0.5s cubic-bezier(.25,.8,.25,1);
        color: var(--google-grey-300);        
      }
      .header {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-top: 30px;
      }
      .item {
        position: relative;
        @apply(--layout-vertical);
        margin-bottom: 15px;
      }
      .item > div {
        margin-left: 15px;
        margin-bottom: 10px;
      }
      .item_name {
        font-weight: bold;
        font-size: 1.1em;
        margin-left: 0 !important;
      }
      .item_date {
        
      }
      .item_tag_list {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }
      .item_tag {
        font-size: 0.75em;
        margin-right: 20px; 
        background-color: var(--google-blue-100);
        padding: 5px;
        border-radius: 2px;
      }
      .item_warpscript {
        padding: 5px;
        font-family: 'Roboto Mono', sans-serif;
        font-size: 0.75em;
        -moz-box-shadow:    inset 0 0 2px #AAA;
        -webkit-box-shadow: inset 0 0 2px #AAA;
        box-shadow:         inset 0 0 2px #AAA; 
        max-height: 100px;
        overflow: auto;       
      }
    </style>

    <app-pouchdb-index
        db-name="ws001"
        name="main"
        fields='["_id","timestamp"]'>
    </app-pouchdb-index>
    <app-pouchdb-query
        id="query"
        db-name="ws001"
        selector="timestamp $gt 0"
        fields='["_id", "name", "tags", "timestamp", "warpscript"]'
        sort='["timestamp"]'
        data="{{collection}}">
    </app-pouchdb-query>

    <paper-button
        id = "closeReadCollection"
        on-tap = "cancel">
      <iron-icon icon = "close"></iron-icon>
    </paper-button>

    <h2>{{localize('title')}}</h2>

    <template is="dom-repeat" items="{{collection}}" as="record">
      <div class="item">
        
        <div class="item_name">{{record.name}}</div>
        
        <div class="item_date">
          Saved on: 
          <moment-js 
              date="{{_fromTimestampToDate(record.timestamp)}}" 
              format="YYYY-MM-DD HH:mm:ss"
              utc></moment-js> 
          (UTC)
        </div>

        <div class="item_tag_list">          
          <template is="dom-repeat" items="[[record.tags]]" as="tag">
            <div class="item_tag">
              {{tag}}
            </div>
          </template>
        </div>

        <div class="item_warpscript">
          {{record.shortWarpscript}}
        </div>
      </div>
    </template> 
    
  </template>
  <script>
    Polymer({
      is: "quantum-local-collection-reader",

      behaviors : [
        Polymer.PaperDialogBehavior, 
        Polymer.AppLocalizeBehavior 
      ],

      properties: {

        /**
         * The Warscript collection object
         */
        collection: {
          type: Array,
          notify: true,
          observer: "onCollectionChange"
        },      
        language: {
          value: 'en'
        },     
        /* Overriden from AppLocalizeBehavior */
        resources: {
          type: Object,
          value: function() {
            return {
              'en': { 
                'title': 'Load a script from local storage'
              },
            }
          }
        }         
      },

      listeners: {
        'iron-overlay-opened': 'onOpen'
      },
      onOpen: function() {
        console.debug("[quantum-local-collection-reader] onOpen - Openend");
        this.$.query.refresh();
      },
      onCollectionChange: function() {
        console.debug("[quantum-local-collection-reader] onCollectionChange", this.collection);
        for (var i in this.collection) {
          this.collection[i].shortWarpscript = this._shortWarpscript(this.collection[i].warpscript);
        }
      },
      /**
      * Convert token timestamps to dates
      */
      _fromTimestampToDate: function(ts) {
        console.debug("[quantum-local-collection-reader] _fromTimestampToDate", ts)
        return new Date(ts).toISOString();  
      },
      _shortWarpscript: function(warpscript) {
        var shortWarpscript = this._trimExcessLineFeeds(warpscript).substring(0,256);

        
        if (shortWarpscript.length != warpscript.length) {
          shortWarpscript = shortWarpscript+ "...";
        }       
        
        console.debug("[quantum-local-collection-reader] _shortWarpscript", shortWarpscript);
        return shortWarpscript
      },
      _trimExcessLineFeeds: function(warpscript) {
        var maxNumberOfLineFeeds = 3
        var numberOfLineFeeds = 0;
        var i;
        for (i in warpscript.length) {
          if (warpscript[i] == "\n") {
            numberOfLineFeeds++;
          }
          if (numberOfLineFeeds >= maxNumberOfLineFeeds) {
            break;
          }
        }
        return warpscript.substring(0,i);
      }
    });
  </script>
</dom-module>  