<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">

<link rel="import" href="../warp10-iron/warp10-warpscript-caller.html">
<link rel="import" href="../warp10-iron/warp10-gts-tools.html">
<link rel="import" href="../warp10-iron/warp10-simple-overlay.html">
<link rel="import" href="../warp10-iron/warp10-looseJSON.html">

<link rel="import" href="../granite-alert/granite-alert.html">

<link rel="import" href="../ace-widget/ace-widget.html">

<link rel="import" href="../granite-spinner/granite-spinner.html">

<link rel="import" href="./quantum-module-behavior.html">
<link rel="import" href="./quantum-response-container.html">
<link rel="import" href="./quantum-permalink.html">

<script src="../ace/mode-warpscript.js"></script>
<script src="../ace-builds/src-min-noconflict/theme-eclipse.js"></script>
<script src="../ace-builds/src-min-noconflict/snippets/text.js"></script>

<dom-module id="quantum-warpscript">  
  <template>
    <style>
      :host {
        display: block;
        padding: 15px;
        --app-primary-color: var(--google-blue-500);
        --app-secondary-color: black;
        --app-background-color: white;
        --app-on-background-color: white;
      }
      ace-widget {
        --ace-widget-editor: {
          box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        };
      }
      .ace-editor {
        font-size: 18px;
      }
      .top-10 { margin-top:10px; }

      .left {
        float: left;
      }
      .right {
        float: right;
      }
      .btn[hidden],
      quantum-permalink-generator[hidden],
      quantum-response-container[hidden]{
        display: none;
      }
      .overlayBox {
        display:flex;
        flex-flow: row;
        justify-content: center;
        font-size: 1.2em;
      }
      .overlayContent  {
      }
      .hotkey-key {
        background-color: #333;
        border: 1px solid #333;
        border-radius: 5px;
        box-shadow: 0 1px 0 #666 inset, 0 1px 0 #bbb;
        color: #fff;
        display: inline-block;
        font-size: 1em;
        margin-right: 5px;
        padding: 5px 9px;
        text-align: center;
      }
      granite-alert[hidden] {
        display: none;
      }
      paper-button {
        background-color: var(--app-primary-color);
        color: var(--app-on-background-color)
      }
      granite-spinner {
        z-index: 100;
      }
    </style>

    <style>
      .item { 
        margin-top: 8px; 
        margin-bottom: 8px; 
      } 

      .item_name { 
        color: var(--paper-grey-600); 
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        font-size: 12px; 
        font-weight: 400; 
        letter-spacing: 0.011em; 
        line-height: 20px; 
      } 
      .item_value { 
        @apply(--layout-horizontal); 
        @apply(--layout-center); 
        @apply(--layout-wrap); 
      } 
      .item_vert {
        @apply(--layout-vertical);
      }
      .clearfix:before,
      .clearfix:after {
        content: " "; /* 1 */
        display: table; /* 2 */
      }
      .clearfix:after {
        clear: both;
      }      
      .title {
        text-transform: capitalize;
      }
    </style>

    <h2 class="title">WarpScript</h2>

    <iron-a11y-keys target="[[_target]]" keys="e" on-keys-pressed="_hotkeyExecute"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="p" on-keys-pressed="_hotkeyPlot"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="h ?:keypress" on-keys-pressed="_hotkeyHelp"></iron-a11y-keys>
    <warp10-simple-overlay id="warpscript-ide-keyboard-shortcuts-overlay">
      <div class="overlay-box">
        <h4>Keyboard Shortcuts:</h4>
        <p><span class="hotkey-key">?</span> Show / hide this help menu</p>
        <p><span class="hotkey-key">e</span> Execute WarpScript</p>
        <p><span class="hotkey-key">p</span> Plot result</p>
      </div>
    </warp10-simple-overlay>

    <warp10-warpscript-caller
      id="warpscriptcaller"
      url="{{_baseUrl}}" warpscript="{{warpscriptScript}}"
      on-response="_handleResponse"  on-error="_handleError"
      loading="{{loading}}">
    </warp10-warpscript-caller>

    <iron-ajax
      id="shareCodeRequest" url="{{czdBackend.url}}{{czdBackend.execEndpoint}}"
      content-type="application/x-www-form-urlencoded; charset=UTF-8"
      method='POST' body='{{_codeToShare}}'
      handle-as="text"  on-response="_handleShareCodeResponse" on-error="_handleShareCodeError"
      loading="{{loading}}" debounce-duration="{{debounceDuration}}" 
      ></iron-ajax>

    <iron-ajax
      id="shareResultRequest" url="{{czdBackend.url}}{{czdBackend.execEndpoint}}"
      content-type="application/x-www-form-urlencoded; charset=UTF-8"
      method='POST' body='{{_resultToShare}}'
      handle-as="text"  on-response="_handleShareResultResponse" on-error="_handleShareResultError"
      loading="{{loading}}" debounce-duration="{{debounceDuration}}" 
      ></iron-ajax>
    <ace-widget
        id="editor" 
        theme="ace/theme/eclipse" 
        mode="ace/mode/warpscript"
        softtabs="true" 
        wrap="true" 
        value="{{content}}" 
        placeholder="Type your WarpScript here..."
        initial-focus></ace-widget>


    <granite-spinner
        active="{{loading}}" 
        size="200"
        hover></granite-spinner>

    <quantum-permalink-generator
      warpscript="{{content}}" 
      backend="{{backend}}" 
      hidden$="{{!showPermalink}}"></quantum-permalink-generator>

    <div  class="top-10">
      <template is="dom-if" if="{{!hidePlot}}">
        <div class="left">
          <paper-button
            on-click="plot"
            disabled$="{{loading}}"
            hidden$="{{!_hasAResponse}}">
            Plot
          </paper-button>
        </div>
      </template>
      <div class="right">

        <paper-button
          id="btn_execute"
          class="btn btn-primary btn-lg"
          on-click="execute"
          disabled$="{{loading}}">
          Execute!
        </paper-button>
      </div>
    </div>


    
    <template is="dom-if" if="{{_hasAResponse}}">      
      <div class="clearfix"> </div>
      <div  class="top-10">
        <paper-button
            id="btn_share_result"
            on-click="shareResult"
            disabled$="{{_shareResultDisabled}}">
            Share result
        </paper-button>  
        <template is="dom-if" if="{{_lastSharedResult.snapshotId}}">  
          <div class="item_vert">
            <div class="item">
              Link to share: 
              <a href$="./#/shared-result/{{_lastSharedResult.snapshotId}}" target="_blank">
                {{_sharingUrlRoot}}#/shared-result/{{_lastSharedResult.snapshotId}}
                </a>
            </div>
            <div class="item">
              Link to delete: 
              <a href$="./#/delete-shared-result/{{_lastSharedResult.snapshotId}}/{{_lastSharedResult.snapshotSecret}}" target="_blank">
                {{_sharingUrlRoot}}#/delete-shared-result/{{_lastSharedResult.snapshotId}}/{{_lastSharedResult.snapshotSecret}}
              </a>
            </div>
          </div>
        </template>
      </div>
    </template>

    <template is="dom-if" if="{{!_contentChangedAfterExecution}}">             
      <div class="clearfix"> </div>
      <div  class="top-10">
        <paper-button
          id="btn_share_code"
          class="btn btn-primary btn-lg"
          on-click="shareCode"
          disabled$="{{_shareCodeDisabled}}">
          Share code
        </paper-button>
        <template is="dom-if" if="{{_lastSharedCode.snapshotId}}">  
          <div class="item_vert">
            <div class="item">
              Link to share: 
              <a href$="./#/shared-code/{{_lastSharedCode.snapshotId}}" target="_blank">
                {{_sharingUrlRoot}}#/shared-code/{{_lastSharedCode.snapshotId}}
                </a>
            </div>
            <div class="item">
              Link to delete: 
              <a href$="./#/delete-shared-code/{{_lastSharedCode.snapshotId}}/{{_lastSharedCode.snapshotSecret}}" target="_blank">
                {{_sharingUrlRoot}}#/delete-shared-code/{{_lastSharedCode.snapshotId}}/{{_lastSharedCode.snapshotSecret}}
              </a>
            </div>
          </div>
        </template>
      </div>
    </template>

    <template is="dom-if" if="{{_elapsedTimeShown}}">
      <div class="clearfix"> </div>
      <div  class="top-10">
        <div class="right">Your script execution took {{_formattedElapsedTime}} serverside</div>
      </div>
    </template>
    <div class="clearfix"> </div>

    <div  class="top-10">
      <quantum-response-container
        id="response_container"
        response="{{stack}}"
        received="{{received}}" 
        hidden$="{{!_hasAResponse}}"></quantum-response-container>
      <granite-alert level="danger" hidden$="{{!_hasAnError}}">
        {{errorMsg}}
      </granite-alert>
    </div>


  </template>

  <script>
    Polymer({
      is:"quantum-warpscript",
      behaviors: [
        QuantumModule
      ],
      properties: {

        /**
         * Fired when user clicks on plot
         *
         * @event plot
         * @param {Array} the stack
         */

        /**
         * The application name for this widget
         */
        application: {
          type: String,
        },
        /**
         * The WarpScript
         */
        content: {
          type: String,
          value: "",
          observer: "_onContentChange"
        },
        /**
         * The name of the currently selected module
         */
        selected: {
          type: String,
          observer: "_onSelectedChanged"
        },

        _dataToPlot: {
          type: Array,
          notify: true
        },
        _target: {
          type: Object,
          value: function() {
            return document.body;
          }
        },

        /**
         * Elapsed time for the call
         */
        elapsed: {
          type: Number,
          value: -1
        },
        _formattedElapsedTime: {
          type: String,
          computed: "_formatElapsedTime(elapsed)"
        },
        _elapsedTimeShown: {
          type: Boolean,
          computed: "_isElapsedTimeShown(elapsed)"
        },

        /**
         * If true, the `quantum-warpscript` component inside this one won't show
         * the plot Button, useful for embedded mode
         */
        showPermalink: {
          type: Boolean,
          value: false
        },
        /**
         * If true, the `quantum-warpscript` component inside this one won't show
         * the plot Button, useful for embedded mode
         */
        hidePlot: {
          type: Boolean,
          value: false
        },
        
        _hasAResponse: {
          type: Boolean,
          value: false
        },
        _hasAnError: {
          type: Boolean,
          value: false
        },
        
        _baseUrl: {
          type: String,
          computed: "_getBaseUrl(backend)"
        },
        _lastSharedCode: {
          type: String,
          value: ""
        },
        _shareCodeDisabled: {
          type: Boolean,
          computed: "_isShareCodeDisabled(loading,_lastSharedCode)"
        },
        _lastSharedResult: {
          type: String,
          value: ""
        },
        _sharingUrlRoot: {
          type: String,
          value: function() {
            return window.location.origin+window.location.pathname;
          } 
        },
        
        _shareResultDisabled: {
          type: Boolean,
          computed: "_isShareResultDisabled(loading,_lastSharedResult)"
        },
        _contentChangedAfterExecution: {
          type: Boolean,
          value: true
        },
      },

      

      /**************************************************************************/
      /* Lifecycle methods                                                      */
      /**************************************************************************/
      ready: function() {

      },
      attached: function() {
        editor = this.$.editor;
        editor.addEventListener('editor-content', this.editorChangeAction.bind(this));
        if (this.showPermalink) {
          this.debounce('updateLocation', this._updateLocation, 500);
        }
      },

      /**************************************************************************/
      /* Computed properties                                                    */
      /**************************************************************************/
      _formatElapsedTime: function() {
        if (this.elapsed < 1000) {
          return ""+this.elapsed+" ns";
        }
        if (this.elapsed < 1000000) {
          return ""+(this.elapsed/1000).toFixed(3)+" μs";
        }
        if (this.elapsed < 1000000000) {
          return ""+(this.elapsed/1000000).toFixed(3)+" ms";
        }
        return ""+(this.elapsed/1000000000).toFixed(3)+" s";
      },
      _isElapsedTimeShown: function() {
        if (this.elapsed >0) {
          return true;
        }
        return false;
      },
      _getBaseUrl: function() {
        return this.backend.url + this.backend.execEndpoint;
      },

      _isShareCodeDisabled: function() {
        return !!(this.loading || (this._lastSharedCode && this._lastSharedCode.snapshotId) );
      },
      _isShareResultDisabled: function() {
        return !!(this.loading || (this._lastSharedResult && this._lastSharedResult.snapshotId) );
      },
      /**************************************************************************/
      /* Observers                                                              */
      /**************************************************************************/
      _onContentChange: function(content) {
        console.debug("[quantum-warpscript] _onContentChange", content);
        this._contentChangedAfterExecution = true;
        this._lastSharedCode = false;
        if (this.showPermalink) {
          this.debounce('updateLocation', this._updateLocation, 500);
        }
      },
      _onSelectedChanged: function(selected) {
        
        if (selected === this.name) {
          this._target = document.body;          
        } else {
          this._target = null;
        }
        // console.debug("[warp10-warpscript-plot] _onSelectedChanged", {selected: selected, name:this.name, target: this._target});
      },

      /**************************************************************************/
      /* Event Listeners                                                        */
      /**************************************************************************/
      _handleResponse: function(event, response) {      
        if (!response.stack ||
          !response.stack instanceof Array ) {
          this._dataToPlot = null;
          return;
        }        
        this.elapsed = response.options.elapsed;
        this._dataToPlot = gtsTools.gtsFromJSONList(response.stack);
        this.stack = response.stack;  
        this._hasAResponse = true;
        this._hasAnError = false;
        this._contentChangedAfterExecution = false;
        this._lastSharedResult = "";
        this.$.response_container.responseChanged();
        
        // console.debug("[quantum-warpscript] _handleResponse", { stack: this.stack, elapsed: this.elapsed, _dataToPlot: this._dataToPlot });
      },    
      _handleError: function(event, error) {        
        if (error.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)) {
          this.errorMsg = error.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)[1]; 
        } else {
          this.errorMsg =  error.request.statusText;
        }
        
        console.debug("[quantum-warpscript] _handleError", { error: error, errorMsg: this.errorMsg });
        
        this.elapsed = error.elapsed;
        this._hasAResponse = false;
        this._hasAnError = true;       
        
        console.debug("[quantum-warpscript] _handleError - _hasAResponse", this._hasAResponse);
      },

      editorChangeAction: function(value, oldValue) {
        this.content  = value.detail.value;
        // console.debug("[quantum-warpscript] editorChangeAction", this.content);
      },

      _handleShareCodeResponse: function(event, ironRequest) {
        var snapshotId = looseJSON.parse(ironRequest.response)[1];
        var snapshotSecret = looseJSON.parse(ironRequest.response)[0];
        console.debug("quantum-warpscript] _handleShareCodeResponse", {snapshotId: snapshotId, snapshotSecret: snapshotSecret});
        this._lastSharedCode = {snapshotId: snapshotId, snapshotSecret: snapshotSecret};
      },  
      _handleShareResultResponse: function(event, ironRequest) {
        var snapshotId = looseJSON.parse(ironRequest.response)[1];
        var snapshotSecret = looseJSON.parse(ironRequest.response)[0];
        console.debug("quantum-warpscript] _handleShareResultResponse", ironRequest.response);
        this._lastSharedResult =  {snapshotId: snapshotId, snapshotSecret: snapshotSecret};
      },         
      /**************************************************************************/
      /* Action listeners                                                       */
      /**************************************************************************/    
      /**
       * Executes the warpscript request
       */
      execute: function() {
        console.debug("[quantum-warpscript] Execute", this.content)
        if (this.showPermalink) {
          this._updateLocation();
        }
        this.warpscriptScript = this.content;
        this.$.warpscriptcaller.generateRequest();    
      },
      plot: function() {
        // console.debug([quantum-warpscript] Plot", this.stack)
        if (this.stack.length) {
          this.fire("plot",this._dataToPlot);
        }
      },
      shareCode: function() {        
        this._codeToShare = "<% '"+ encodeURI(this.content).replace(/'/g,'%27').replace(/"/g,'%28').replace(/\+/g,'%2B') + "' %> @orbit/snapshot/store";
        this.$.shareCodeRequest.generateRequest();    
      },
      shareResult: function() {
        this._resultToShare = this.content + " SNAPSHOT 'snapshot' STORE <% !$snapshot %> @orbit/snapshot/store";
        this.$.shareResultRequest.generateRequest();    
      },


      /**************************************************************************/
      /* Other methods                                                          */
      /**************************************************************************/
       
      _updateLocation: function() {
        console.debug("[quantum-warpscript] _updateLocation");
        this.$$("quantum-permalink-generator").updateLocation(this.application);
      },


      /**************************************************************************/
      /* Hotkeys                                                                */
      /**************************************************************************/      
      _hotkeyExecute: function(e) {
        var normKeyboardEvt = Polymer.dom(e.detail.keyboardEvent);
        console.debug("[quantum-warpscript] _hotkeyExec", normKeyboardEvt.rootTarget);
        var nodeName =  normKeyboardEvt.rootTarget.nodeName;
        if ((nodeName !== 'TEXTAREA') && (nodeName !== 'INPUT')) {
          this.execute();
        }
      },
      _hotkeyPlot: function(e) {
        var normKeyboardEvt = Polymer.dom(e.detail.keyboardEvent);
        console.debug("[quantum-warpscript] _hotkeyExec", normKeyboardEvt.rootTarget);
        var nodeName =  normKeyboardEvt.rootTarget.nodeName;
        if ((nodeName !== 'TEXTAREA') && (nodeName !== 'INPUT')) {
          this.plot();
        }
      },
      _hotkeyHelp: function(e) {
        var normKeyboardEvt = Polymer.dom(e.detail.keyboardEvent);
        console.debug("[quantum-warpscript] _hotkeyExec", normKeyboardEvt.rootTarget);
        var nodeName =  normKeyboardEvt.rootTarget.nodeName;
        if ((nodeName !== 'TEXTAREA') && (nodeName !== 'INPUT')) {
          console.debug("[quantum-warpscript] _hotkeyHelp")
          if (!this.$$("#warpscript-ide-keyboard-shortcuts-overlay").opened) {
            this.$$("#warpscript-ide-keyboard-shortcuts-overlay").open();
          } else {
            this.$$("#warpscript-ide-keyboard-shortcuts-overlay").close();
          }
        }
      },


    })
  </script>
</dom-module>
